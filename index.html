<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Download Whale App</title>
        <style></style>
    </head>
    <body>
        <div class="button-group">
            <a id="top-btn-apk-click" href="#">
                <span>Download apk</span>
            </a>
        </div>

        <script>
            /**
             * Whale App - Complete Tracking & Attribution Script
             * APK: Full fingerprinting + tracking backend
             * iOS: GTM only (no redirect, no fingerprinting)
             */

            document.addEventListener("DOMContentLoaded", function () {
                // ===== CONFIGURATION =====
                const CONFIG = {
                    API_ENDPOINT:
                        "https://europe-west1-whale-app-android.cloudfunctions.net/apk-attribution-service",
                    APK_URL:
                        "https://crashgame-prod.b-cdn.net/testing-pooja-dev-app-updates/whale.apk",
                    BUTTON_IDS: {
                        apk: "top-btn-apk-click",
                        ios: "top-btn-ios-click",
                    },
                    STORAGE_KEYS: {
                        visitorId: "whale_visitor_id",
                        trackingData: "whale_tracking_data",
                    },
                };

                // ===== GET URL PARAMETERS =====
                const urlParams = new URLSearchParams(window.location.search);
                const affiliateCode =
                    urlParams.get("ref") ||
                    urlParams.get("code") ||
                    urlParams.get("start") ||
                    "whale_apk_site";

                // ===== INITIALIZE IDENTIFIERS =====
                function generateIdentifiers() {
                    let visitorId = localStorage.getItem(
                        CONFIG.STORAGE_KEYS.visitorId,
                    );
                    if (!visitorId) {
                        visitorId =
                            "web_" +
                            Date.now() +
                            "_" +
                            Math.random().toString(36).substr(2, 9);
                        localStorage.setItem(
                            CONFIG.STORAGE_KEYS.visitorId,
                            visitorId,
                        );
                    }
                    return {
                        visitorId: visitorId,
                        timestamp: Date.now(),
                    };
                }

                const identifiers = generateIdentifiers();

                // ===== FINGERPRINTING FUNCTIONS (FOR APK ONLY) =====

                async function getPublicIP() {
                    try {
                        const response = await fetch(
                            "https://api.ipify.org?format=json",
                        );
                        const data = await response.json();
                        return data.ip;
                    } catch (error) {
                        console.warn("Failed to get public IP:", error);
                        return "unknown";
                    }
                }

                function getNetworkType() {
                    if ("connection" in navigator) {
                        const connection = navigator.connection;
                        if (connection) {
                            return connection.type || "unknown";
                        }
                    }
                    return "unknown";
                }

                function getScreenBucket(width, height) {
                    const diagonal =
                        Math.sqrt(width * width + height * height) / 160;
                    if (diagonal >= 6.5) return "large";
                    if (diagonal >= 5.5) return "medium";
                    return "small";
                }

                function hashObject(obj) {
                    const str = JSON.stringify(obj, Object.keys(obj).sort());
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        const char = str.charCodeAt(i);
                        hash = (hash << 5) - hash + char;
                        hash = hash & hash;
                    }
                    return Math.abs(hash).toString(36);
                }

                function createDeviceSignature(
                    physicalScreen,
                    platformInfo,
                    publicIP,
                    networkType,
                ) {
                    const signatureData = {
                        width: physicalScreen.physicalWidth,
                        height: physicalScreen.physicalHeight,
                        dpr: Math.round(physicalScreen.dpr * 10) / 10,
                        bucket: physicalScreen.screenBucket,
                        platform: platformInfo.platform,
                        language: platformInfo.language,
                        publicIP: publicIP,
                        networkType: networkType,
                    };
                    return `device_${hashObject(signatureData)}`;
                }

                function createStrictHash(
                    physicalScreen,
                    platformInfo,
                    publicIP,
                ) {
                    const data = {
                        physicalWidth: physicalScreen.physicalWidth,
                        physicalHeight: physicalScreen.physicalHeight,
                        dpr: physicalScreen.dpr,
                        platform: platformInfo.platform,
                        concurrency: platformInfo.hardwareConcurrency,
                        publicIP: publicIP,
                        language: platformInfo.language,
                    };
                    return `strict_${hashObject(data)}`;
                }

                function createRelaxedHash(
                    physicalScreen,
                    localeInfo,
                    publicIP,
                ) {
                    const data = {
                        screenBucket: physicalScreen.screenBucket,
                        dpr: Math.round(physicalScreen.dpr),
                        timezone: localeInfo.timezone,
                        language: localeInfo.locale,
                        publicIP: publicIP,
                    };
                    return `relaxed_${hashObject(data)}`;
                }

                function createBasicHash(physicalScreen, publicIP) {
                    const data = {
                        width:
                            Math.round(physicalScreen.physicalWidth / 10) * 10,
                        height:
                            Math.round(physicalScreen.physicalHeight / 10) * 10,
                        dpr: Math.round(physicalScreen.dpr),
                        publicIP: publicIP,
                    };
                    return `basic_${hashObject(data)}`;
                }

                async function collectEnhancedFingerprint() {
                    const dpr = window.devicePixelRatio || 1;
                    const physicalWidth = Math.round(screen.width * dpr);
                    const physicalHeight = Math.round(
                        (screen.availHeight || screen.height) * dpr,
                    );

                    const publicIP = await getPublicIP();
                    const networkType = getNetworkType();

                    const physicalScreen = {
                        physicalWidth: physicalWidth,
                        physicalHeight: physicalHeight,
                        dpr: dpr,
                        screenBucket: getScreenBucket(
                            physicalWidth,
                            physicalHeight,
                        ),
                    };

                    const platformInfo = {
                        platform: navigator.platform,
                        language: navigator.language,
                        languages: navigator.languages
                            ? navigator.languages.join(",")
                            : "",
                        maxTouchPoints: navigator.maxTouchPoints || 0,
                        hardwareConcurrency:
                            navigator.hardwareConcurrency || "unknown",
                        deviceMemory: navigator.deviceMemory || "unknown",
                        touchSupport: "ontouchstart" in window,
                    };

                    const localeInfo = {
                        timezone:
                            Intl.DateTimeFormat().resolvedOptions().timeZone,
                        locale: navigator.language,
                    };

                    return {
                        publicIP: publicIP,
                        networkType: networkType,
                        deviceSignature: createDeviceSignature(
                            physicalScreen,
                            platformInfo,
                            publicIP,
                            networkType,
                        ),
                        physicalScreen: physicalScreen,
                        platformInfo: platformInfo,
                        localeInfo: localeInfo,
                        strictHash: createStrictHash(
                            physicalScreen,
                            platformInfo,
                            publicIP,
                        ),
                        relaxedHash: createRelaxedHash(
                            physicalScreen,
                            localeInfo,
                            publicIP,
                        ),
                        basicHash: createBasicHash(physicalScreen, publicIP),
                    };
                }

                // ===== TRACKING FUNCTIONS =====

                async function trackVisit() {
                    try {
                        const fingerprint = await collectEnhancedFingerprint();

                        const trackingData = {
                            affiliateCode: affiliateCode,
                            identifiers: identifiers,
                            fingerprint: fingerprint,
                            matchingHashes: {
                                strict: fingerprint.strictHash,
                                relaxed: fingerprint.relaxedHash,
                                basic: fingerprint.basicHash,
                                deviceSignature: fingerprint.deviceSignature,
                            },
                            timestamp: Date.now(),
                            url: window.location.href,
                        };

                        localStorage.setItem(
                            CONFIG.STORAGE_KEYS.trackingData,
                            JSON.stringify(trackingData),
                        );

                        const response = await fetch(
                            CONFIG.API_ENDPOINT + "/track-visit",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(trackingData),
                            },
                        );

                        if (response.ok) {
                            const result = await response.json();
                            console.log(
                                "âœ… Visit tracked:",
                                result.matchStrategy || "new",
                            );
                            return result;
                        }
                    } catch (error) {
                        console.warn("âš ï¸ Visit tracking failed:", error);
                    }
                }

                async function trackAPKDownload() {
                    try {
                        const fingerprint = await collectEnhancedFingerprint();

                        const downloadData = {
                            affiliateCode: affiliateCode,
                            visitorId: identifiers.visitorId,
                            buttonType: "apk",
                            deviceSignature: fingerprint.deviceSignature,
                            matchingHashes: fingerprint.matchingHashes,
                            publicIP: fingerprint.publicIP,
                            networkType: fingerprint.networkType,
                            timestamp: Date.now(),
                            event: "apk_download_click",
                        };

                        await fetch(CONFIG.API_ENDPOINT + "/track-download", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(downloadData),
                        });

                        console.log("âœ… APK Download tracked");
                    } catch (error) {
                        console.warn("âš ï¸ APK Download tracking failed:", error);
                    }
                }

                // ===== GTM TRACKING FOR IOS =====

                document.body.addEventListener("click", function (event) {
                    var target = event.target.closest("a#top-btn-ios-click");
                    if (target) {
                        window.dataLayer = window.dataLayer || [];
                        dataLayer.push({
                            event: "custom_click",
                            button_id: "top-btn-ios-click",
                        });
                    }
                });

                // ===== APK BUTTON HANDLER =====

                document
                    .getElementById(CONFIG.BUTTON_IDS.apk)
                    .addEventListener("click", function (event) {
                        event.preventDefault();
                        console.log("ðŸ”˜ APK download button clicked");

                        trackAPKDownload();

                        setTimeout(() => {
                            window.location.href = CONFIG.APK_URL;
                        }, 300);
                    });

                // ===== INITIALIZE =====

                trackVisit();

                // Initialize debug info
                (async () => {
                    const fingerprint = await collectEnhancedFingerprint();
                    const debugInfo = {
                        affiliateCode: affiliateCode,
                        visitorId: identifiers.visitorId,
                        publicIP: fingerprint.publicIP,
                        networkType: fingerprint.networkType,
                        matchingHashes: fingerprint.matchingHashes,
                        deviceSignature: fingerprint.deviceSignature,
                        physicalScreen: fingerprint.physicalScreen,
                        platform: fingerprint.platformInfo.platform,
                        language: fingerprint.platformInfo.language,
                        timezone: fingerprint.localeInfo.timezone,
                    };
                })();

                console.log("âœ… Whale App Tracking Script Loaded");
                console.log("   APK: Full tracking + download");
                console.log("   iOS: GTM only");
            });
        </script>
    </body>
</html>
